<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- App Initialization ---
        let app;
        let db;
        let auth;
        let userId;
        let isAuthReady = false;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser.uid;
                isAuthReady = true;

                // Display the user ID for sharing
                const userIdDisplay = document.getElementById('userIdDisplay');
                userIdDisplay.textContent = `Your User ID: ${userId}`;
                userIdDisplay.classList.remove('hidden');

                console.log("Firebase initialized and authenticated successfully.");
                
                // Start listening for plans
                setupRealtimeListener();

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Failed to initialize the app. Please check the console for details.';
                errorMessage.classList.remove('hidden');
            }
        });

        // --- Real-time Firestore Listener ---
        function setupRealtimeListener() {
            if (!isAuthReady || !db) return;

            // Use the correct Firestore path as per security rules
            const plansCollection = collection(db, 'artifacts', appId, 'users', userId, 'plans');
            const q = query(plansCollection);

            onSnapshot(q, (snapshot) => {
                const plansList = document.getElementById('plansList');
                plansList.innerHTML = '';
                const plans = [];
                snapshot.forEach((doc) => {
                    plans.push({ id: doc.id, ...doc.data() });
                });
                renderPlans(plans);
            }, (error) => {
                console.error("Error listening to plans:", error);
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = 'Error fetching plans. Please check the console.';
                errorMessage.classList.remove('hidden');
            });
        }

        // --- DOM Elements ---
        const addPlanForm = document.getElementById('addPlanForm');
        const planInput = document.getElementById('planInput');

        // --- Event Listeners ---
        addPlanForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const planText = planInput.value.trim();
            if (planText !== '') {
                await addPlan(planText);
                planInput.value = '';
            }
        });

        // --- Custom Modal Functions (replaces alert/confirm/prompt) ---
        function showPromptModal(message, defaultValue, callback) {
            const modal = document.getElementById('customModal');
            const messageEl = document.getElementById('modalMessage');
            const inputEl = document.getElementById('modalInput');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');

            messageEl.textContent = message;
            inputEl.value = defaultValue;
            inputEl.classList.remove('hidden');
            cancelBtn.classList.remove('hidden');
            confirmBtn.textContent = 'OK';

            modal.classList.remove('hidden');
            inputEl.focus();

            function onConfirm() {
                callback(inputEl.value);
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
            }

            function onCancel() {
                callback(null);
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
            }

            confirmBtn.addEventListener('click', onConfirm);
            cancelBtn.addEventListener('click', onCancel);
        }

        function showConfirmModal(message, callback) {
            const modal = document.getElementById('customModal');
            const messageEl = document.getElementById('modalMessage');
            const inputEl = document.getElementById('modalInput');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document = document.getElementById('modalCancelBtn');

            messageEl.textContent = message;
            inputEl.classList.add('hidden');
            cancelBtn.classList.remove('hidden');
            confirmBtn.textContent = 'Yes';
            
            modal.classList.remove('hidden');

            function onConfirm() {
                callback(true);
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
            }

            function onCancel() {
                callback(false);
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
            }

            confirmBtn.addEventListener('click', onConfirm);
            cancelBtn.addEventListener('click', onCancel);
        }

        // --- CRUD Functions ---
        async function addPlan(text) {
            if (!isAuthReady || !db) return;
            try {
                const plansCollection = collection(db, 'artifacts', appId, 'users', userId, 'plans');
                await addDoc(plansCollection, {
                    text: text,
                    timestamp: new Date()
                });
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        async function updatePlan(id, newText) {
            if (!isAuthReady || !db) return;
            try {
                const planDoc = doc(db, 'artifacts', appId, 'users', userId, 'plans', id);
                await updateDoc(planDoc, { text: newText });
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        }

        async function deletePlan(id) {
            if (!isAuthReady || !db) return;
            try {
                const planDoc = doc(db, 'artifacts', appId, 'users', userId, 'plans', id);
                await deleteDoc(planDoc);
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        }

        // --- UI Rendering ---
        function renderPlans(plans) {
            const plansList = document.getElementById('plansList');
            plansList.innerHTML = '';
            plans.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
            
            plans.forEach(plan => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg shadow-sm mb-2 hover:bg-gray-100 transition-colors duration-200 ease-in-out';
                li.innerHTML = `
                    <div class="flex-grow">
                        <span class="text-gray-800 text-lg">${escapeHtml(plan.text)}</span>
                    </div>
                    <div class="flex-shrink-0 ml-4 space-x-2">
                        <button class="edit-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm font-semibold shadow hover:bg-blue-600 transition-colors" data-id="${plan.id}">Edit</button>
                        <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm font-semibold shadow hover:bg-red-600 transition-colors" data-id="${plan.id}">Delete</button>
                    </div>
                `;
                plansList.appendChild(li);
            });

            // Add event listeners to the new buttons
            plansList.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const planText = e.target.closest('li').querySelector('span').textContent;
                    showPromptModal('Edit your plan:', planText, (newText) => {
                        if (newText !== null && newText.trim() !== '') {
                            updatePlan(id, newText);
                        }
                    });
                });
            });

            plansList.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    showConfirmModal('Are you sure you want to delete this plan?', (isConfirmed) => {
                        if (isConfirmed) {
                            deletePlan(id);
                        }
                    });
                });
            });
        }
        
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 600px;
        }
        /* Custom modal for confirm/prompt replacement */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-input {
            width: 100%;
            padding: 8px;
            margin-top: 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 md:p-8 bg-white rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">My Daily Plans</h1>
        <p id="userIdDisplay" class="text-sm text-gray-500 text-center mb-4 hidden"></p>
        
        <form id="addPlanForm" class="flex flex-col md:flex-row items-stretch mb-6 space-y-2 md:space-y-0 md:space-x-2">
            <input type="text" id="planInput" placeholder="Add a new plan..." class="flex-grow p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500 transition-colors duration-200">
            <button type="submit" class="bg-green-500 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-green-600 transition-colors duration-200">Add Plan</button>
        </form>

        <ul id="plansList" class="space-y-2">
            <!-- Plans will be rendered here dynamically -->
        </ul>
        <p id="errorMessage" class="text-red-500 text-center mt-4 hidden"></p>
    </div>

    <!-- Custom Modal for Prompt and Confirm (replaces alert/confirm/prompt) -->
    <div id="customModal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="modalMessage" class="text-gray-700"></p>
            <input type="text" id="modalInput" class="modal-input hidden">
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-600">OK</button>
                <button id="modalCancelBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-bold hover:bg-gray-400">Cancel</button>
            </div>
        </div>
    </div>
</body>
</html>
